#####################################################################
#   Includes
#####################################################################

[include eddy.cfg]
[include led.cfg]
[include KAMP_Settings.cfg]
[include mainsail.cfg]
[include macros.cfg]
[include knomi.cfg]

#####################################################################
#   Printer Settings
#####################################################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_090029000751313433343333-if00
restart_method: command

[mcu EBB]
serial: /dev/serial/by-id/usb-Klipper_rp2040_5044340310374C1C-if00 

[printer]
kinematics: corexy
max_velocity: 800  
max_accel: 25000
#minimum_cruise_ratio: 0       #Max 4000
max_z_velocity: 20          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 400
square_corner_velocity: 8.0

[gcode_arcs]
resolution: 0.1  # Optional, sets the resolution for arc approximation in mm

[virtual_sdcard]
path: ~/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
max_temp: 100

[lis2dw]
cs_pin: EBB:gpio1
spi_bus: spi0a
axes_map: z,x,y

[resonance_tester]
probe_points: 100, 100, 20
accel_chip: lis2dw

[gcode_macro _global_var]
variable_heat_soak_time: 5  # Default heat soak time in minutes
variable_bed_mesh_calibrate_target_temp: 60  # Default mesh calibration temperature
gcode:
    # This is a placeholder to satisfy Klipper's requirement for a gcode option
    RESPOND MSG="This macro is for storing global variables only."

[delayed_gcode print_start_wait]
gcode:
    # Commands to execute after the delay
    M117 Print Start Wait Completed
    # Add any other final setup commands here
initial_duration: 0.5

[firmware_retraction]
retract_length: 0.8            # Base retraction length
retract_speed: 40              # Speed for retraction
unretract_extra_length: 0.0    # Extra filament on unretract
unretract_speed: 40            # Speed for unretraction

#####################################################################
#   Input Shaper Configuration
#####################################################################

# [adxl345]
# cs_pin: can0: PB12
# spi_software_sclk_pin: can0: PB10
# spi_software_mosi_pin: can0: PB11
# spi_software_miso_pin: can0: PB2
# axes_map: z,-y,x

# [resonance_tester]
# probe_points: 100, 100, 20
# accel_chip: adxl345

#####################################################################
# 	X/Y Stepper Settings
#####################################################################

[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
endstop_pin: tmc5160_stepper_x:virtual_endstop
# diag1_pin: ^PG6
microsteps: 16
rotation_distance: 40
position_endstop: 350
position_max: 350
homing_speed: 80
homing_retract_dist: 0
# second_homing_speed: 40 

[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
endstop_pin: tmc5160_stepper_y:virtual_endstop
#diag1_pin: !PG9
microsteps: 16
rotation_distance: 40
position_endstop: 361
position_max: 361
homing_speed: 80
homing_retract_dist: 0

#####################################################################
# 	Z Stepper Settings
#####################################################################

## Z0 Stepper - Front Left
[stepper_z]
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16
endstop_pin: probe:z_virtual_endstop   
position_min: -5
position_max: 330
homing_speed: 20
second_homing_speed: 3
homing_retract_dist: 3

###########################################################################
#   Z1+ Stepper Motorz
###########################################################################

[stepper_z1]
step_pin: PF9
dir_pin: !PF10
enable_pin: !PG2
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16

[stepper_z2]
step_pin: PE2
dir_pin: PE3
enable_pin: !PD4
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16

[stepper_z3]
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16

########################################
# TMC5160 configuration
########################################

[tmc5160 stepper_x]
cs_pin: PC4
spi_bus: spi1
diag1_pin: !PG6
run_current: 2.4
hold_current: 0.8
stealthchop_threshold: 0
driver_SGT: 2
# interpolate: True

[tmc5160 stepper_y]
cs_pin: PD11
spi_bus: spi1
diag1_pin: !PG9
run_current: 2.4
hold_current: 0.8
stealthchop_threshold: 0
driver_SGT: 1
# interpolate: True

[tmc5160 stepper_z]
cs_pin: PC6
spi_bus: spi1
diag1_pin: PG10
run_current: 0.900
hold_current: 0.3
stealthchop_threshold: 0

# [tmc5160 stepper_unallocated]
# cs_pin: PC7
# spi_bus: spi1
# #diag1_pin: PG11
# run_current: 0.800
# stealthchop_threshold: 0

[tmc5160 stepper_z1]
cs_pin: PF2
spi_bus: spi1
run_current: 0.900
hold_current: 0.3
stealthchop_threshold: 0

[tmc5160 stepper_z2]
cs_pin: PE1
spi_bus: spi1
run_current: 0.900
hold_current: 0.3
stealthchop_threshold: 0

[tmc5160 stepper_z3]
cs_pin: PE4
spi_bus: spi1
run_current: 0.900
hold_current: 0.3
stealthchop_threshold: 0

#[tmc5160 extruder3]
#cs_pin: PD3
#spi_bus: spi1
#run_current: 0.800
#stealthchop_threshold: 0

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=PC5


#####################################################################
#   Extruder Settings
#####################################################################

[tmc2209 extruder]
uart_pin: EBB:gpio20
run_current: 0.650
stealthchop_threshold: 0

[filament_switch_sensor filament_sensor]
pause_on_runout: True
runout_gcode:
    M117 Filament Runout Detected ; Display a message
    PAUSE                         ; Pause the print
insert_gcode:
    M117 Filament Inserted        ; Display a message
    RESUME                        ; Resume the print
switch_pin: EBB:gpio13            ; Correct pin configuration

# [extruder]
# max_extrude_only_distance:1000.0
# max_extrude_cross_section=1000.0
# step_pin: EBB:gpio18
# dir_pin: EBB:gpio19
# enable_pin: !EBB:gpio17
# rotation_distance: 46.515828537772  #Bondtech 5mm Drive Gears
# gear_ratio: 9:1             #BMG Gear Ratio
# microsteps: 32
# full_steps_per_rotation: 200    #200 for 1.8 degree, 400 for 0.9 degree
# nozzle_diameter: 0.400
# filament_diameter: 1.75
# heater_pin: EBB:gpio7
# sensor_type: PT1000
# sensor_pin: EBB:gpio26
# # sensor_type: MAX31865
# # sensor_pin: EBB:gpio9
# # spi_bus: spi1a
# # rtd_nominal_r: 100
# # rtd_reference_r: 430
# # rtd_num_of_wires: 2
# min_temp: 10
# max_temp: 400
# max_power: 1.0
# min_extrude_temp: 170
# pressure_advance: 0.04
# #pressure_advance_smooth_time: 0.040

[extruder]
max_extrude_only_distance: 1000.0
max_extrude_cross_section: 1000.0
step_pin: EBB:gpio18
dir_pin: EBB:gpio19
enable_pin: !EBB:gpio17
rotation_distance: 46.515828537772  # Bondtech 5mm Drive Gears
gear_ratio: 9:1                     # BMG Gear Ratio
microsteps: 32
full_steps_per_rotation: 200        # 200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.600
filament_diameter: 1.75
heater_pin: EBB:gpio7
sensor_type: PT1000                 # Update to PT1000 for the new thermistor
pullup_resistor: 2200               # Correct pull-up resistor value
sensor_pin: EBB:gpio26 
min_temp: 10
max_temp: 400
max_power: 1.0
min_extrude_temp: 170
pressure_advance: 0.04
#pressure_advance_smooth_time: 0.040

#####################################################################
#   Bed Heater Settings
#####################################################################

[heater_bed]
heater_pin: PA3
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF3
max_power: 1
min_temp: 0
max_temp: 115

#####################################################################
#   Fan Control
#####################################################################

[fan]
pin: EBB:gpio14
kick_start_time: 0.5
max_power: 1
off_below: 0.10

[heater_fan hotend_fan]
pin: EBB:gpio4
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

[controller_fan controller_fan]
pin: PD12
kick_start_time: 0.5
max_power: 0.5
heater: heater_bed

[controller_fan controller_fan2]
pin: PD13
kick_start_time: 0.5
max_power: 0.5
heater: heater_bed

[fan_generic Nevermore]
pin: PD14
max_power: 1.0
shutdown_speed: 0

# [heater_fan Nevermore]
# pin: PD14
# heater: extruder
# heater_temp: 240
# max_power: 1.0
# shutdown_speed: 0
# kick_start_time: 0.1

[temperature_fan EBB_SB2209]
pin: EBB:gpio5
sensor_type: Generic 3950
sensor_pin: EBB:gpio27
target_temp: 45.0
control: watermark
max_speed: 1.0
min_temp: 0
max_temp: 100
shutdown_speed: 0

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

[quad_gantry_level]
gantry_corners:
   -60,-10
   410,420
points:
   25, 8.5
   25, 308.5
   325, 308.5
   325, 8.5
speed: 600
horizontal_move_z: 5
retry_tolerance: 0.05
retries: 5
max_adjust: 30

#####################################################################
#   Display and Pin Configuration
#####################################################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=PC5

[exclude_object]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 25.116
#*# pid_ki = 2.093
#*# pid_kd = 75.349
#*#
#*# [probe]
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 56.642
#*# pid_ki = 1.807
#*# pid_kd = 443.935
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 46.2
#*# shaper_type_y = mzv
#*# shaper_freq_y = 37.2
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 17
#*# calibrate =
#*# 	0.050000:3160438.893,0.090000:3160195.050,0.130000:3159969.570,
#*# 	0.170000:3159748.836,0.210000:3159521.710,0.250000:3159297.690,
#*# 	0.290000:3159093.027,0.330000:3158870.824,0.370000:3158667.541,
#*# 	0.410000:3158451.289,0.450000:3158263.530,0.490000:3158058.765,
#*# 	0.530000:3157863.654,0.570000:3157652.323,0.610000:3157483.866,
#*# 	0.650000:3157298.802,0.690000:3157102.414,0.730000:3156939.037,
#*# 	0.770000:3156741.756,0.810000:3156562.887,0.850000:3156400.827,
#*# 	0.890000:3156240.203,0.930000:3156070.767,0.970000:3155903.708,
#*# 	1.010000:3155741.558,1.050000:3155583.370,1.090000:3155440.196,
#*# 	1.130000:3155261.634,1.170000:3155122.338,1.210000:3154972.223,
#*# 	1.250000:3154821.947,1.290000:3154678.246,1.330000:3154539.866,
#*# 	1.370000:3154394.835,1.410000:3154257.091,1.450000:3154112.585,
#*# 	1.490000:3153991.415,1.530000:3153864.338,1.570000:3153708.460,
#*# 	1.610000:3153610.981,1.650000:3153466.197,1.690000:3153344.595,
#*# 	1.730000:3153214.230,1.770000:3153091.173,1.810000:3152973.774,
#*# 	1.850000:3152859.036,1.890000:3152743.651,1.930000:3152642.874,
#*# 	1.970000:3152516.012,2.010000:3152393.006,2.050000:3152277.538,
#*# 	2.090000:3152186.376,2.130000:3152081.871,2.170000:3151998.693,
#*# 	2.210000:3151863.030,2.250000:3151767.198,2.290000:3151659.599,
#*# 	2.330000:3151575.947,2.370000:3151473.759,2.410000:3151364.244,
#*# 	2.450000:3151259.199,2.490000:3151191.088,2.530000:3151088.365,
#*# 	2.570000:3150997.653,2.610000:3150925.798,2.650000:3150807.973,
#*# 	2.690000:3150734.300,2.730000:3150646.597,2.770000:3150562.146,
#*# 	2.810000:3150464.589,2.850000:3150380.483,2.890000:3150296.386,
#*# 	2.930000:3150217.366,2.970000:3150154.817,3.010000:3150067.730,
#*# 	3.050000:3149988.932,3.090000:3149889.860,3.130000:3149817.621,
#*# 	3.170000:3149749.616,3.210000:3149687.480,3.250000:3149604.496,
#*# 	3.290000:3149533.458,3.330000:3149466.655,3.370000:3149372.466,
#*# 	3.410000:3149306.203,3.450000:3149250.035,3.490000:3149165.809,
#*# 	3.530000:3149091.826,3.570000:3149064.051,3.610000:3148989.004,
#*# 	3.650000:3148919.746,3.690000:3148853.686,3.730000:3148795.313,
#*# 	3.770000:3148720.132,3.810000:3148644.821,3.850000:3148610.957,
#*# 	3.890000:3148523.945,3.930000:3148480.368,3.970000:3148428.742,
#*# 	4.010000:3148374.016,4.050000:3148310.652
#*#
#*# [temperature_probe btt_eddy]
#*# calibration_temp = 79.416368
#*# drift_calibration =
#*# 	3149585.693191, 297.257854, -1.934989
#*# 	3146104.798226, 323.336600, -2.119977
#*# 	3143875.087315, 325.155696, -2.123483
#*# 	3141680.477832, 337.418644, -2.203823
#*# 	3140330.800472, 333.935528, -2.174740
#*# 	3138809.057728, 342.659976, -2.234137
#*# 	3137342.611306, 355.454412, -2.326426
#*# 	3135945.286345, 371.157754, -2.439962
#*# 	3135727.653351, 355.059492, -2.316614
#*# drift_calibration_min_temp = 50.16008279444874
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.245647, -0.223252, -0.202572, -0.214833, -0.217660, -0.181010, -0.184617, -0.158927, -0.165064, -0.152131, -0.165158, -0.152225, -0.182888, -0.177956, -0.348994
#*# 	  -0.204197, -0.166216, -0.190478, -0.211704, -0.174503, -0.156238, -0.148935, -0.145537, -0.141880, -0.145278, -0.148675, -0.145278, -0.132419, -0.153000, -0.290331
#*# 	  -0.174065, -0.130655, -0.163323, -0.166726, -0.178191, -0.147115, -0.136922, -0.141169, -0.145772, -0.146266, -0.156459, -0.153944, -0.153095, -0.157165, -0.261133
#*# 	  -0.157702, -0.161807, -0.137597, -0.157321, -0.131036, -0.146700, -0.146700, -0.176772, -0.139016, -0.134413, -0.150059, -0.146661, -0.137251, -0.167183, -0.293863
#*# 	  -0.160717, -0.122440, -0.155123, -0.160905, -0.148408, -0.154546, -0.138215, -0.119763, -0.148816, -0.145418, -0.148816, -0.142652, -0.156431, -0.169187, -0.263310
#*# 	  -0.140291, -0.133414, -0.140210, -0.130672, -0.127197, -0.132817, -0.115936, -0.129000, -0.129929, -0.136944, -0.136944, -0.139967, -0.143365, -0.159692, -0.254600
#*# 	  -0.111052, -0.140162, -0.150192, -0.144054, -0.150975, -0.144179, -0.102687, -0.127647, -0.141603, -0.151304, -0.127144, -0.158456, -0.171514, -0.172399, -0.247868
#*# 	  -0.115549, -0.149887, -0.136597, -0.165867, -0.169265, -0.152933, -0.135473, -0.159616, -0.165210, -0.162658, -0.155754, -0.152853, -0.169356, -0.166292, -0.259534
#*# 	  -0.163373, -0.163063, -0.153930, -0.179081, -0.174823, -0.166865, -0.160707, -0.175466, -0.164778, -0.171408, -0.185303, -0.171408, -0.175889, -0.202066, -0.257046
#*# 	  -0.166865, -0.172964, -0.139791, -0.156125, -0.165826, -0.155763, -0.155763, -0.165958, -0.173424, -0.169059, -0.156124, -0.190061, -0.173027, -0.180693, -0.248788
#*# 	  -0.178681, -0.146223, -0.142825, -0.149984, -0.137707, -0.154041, -0.157439, -0.169669, -0.157916, -0.164215, -0.148964, -0.179965, -0.184224, -0.171966, -0.249171
#*# 	  -0.153461, -0.134663, -0.139597, -0.139597, -0.136857, -0.149793, -0.149532, -0.165867, -0.150026, -0.166343, -0.156455, -0.175039, -0.156455, -0.156132, -0.260997
#*# 	  -0.163768, -0.143155, -0.140415, -0.140638, -0.145736, -0.144036, -0.138572, -0.151509, -0.148768, -0.154907, -0.185334, -0.159338, -0.162074, -0.165617, -0.232161
#*# 	  -0.163917, -0.139824, -0.143223, -0.155475, -0.152584, -0.144937, -0.142881, -0.155819, -0.143097, -0.159433, -0.162831, -0.159433, -0.172859, -0.167401, -0.231273
#*# 	  -0.193633, -0.139952, -0.154260, -0.161058, -0.164872, -0.154675, -0.158074, -0.165081, -0.186156, -0.176735, -0.156210, -0.177199, -0.211148, -0.177199, -0.236683
#*# x_count = 15
#*# y_count = 15
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 334.90000000000003
#*# min_y = 22.0
#*# max_y = 331.95999999999987
