#####################################################################
#   Includes
#####################################################################

[include eddy.cfg]
[include led.cfg]
[include KAMP_Settings.cfg]
[include mainsail.cfg]
[include macros.cfg]
[include knomi.cfg]

#####################################################################
#   Printer Settings
#####################################################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_090029000751313433343333-if00
restart_method: command

[mcu EBB]
serial: /dev/serial/by-id/usb-Klipper_rp2040_5044340310374C1C-if00 

[printer]
kinematics: corexy
max_velocity: 800  
max_accel: 25000
#minimum_cruise_ratio: 0       #Max 4000
max_z_velocity: 20          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 400
square_corner_velocity: 8.0

[gcode_arcs]
resolution: 0.1  # Optional, sets the resolution for arc approximation in mm

[virtual_sdcard]
path: ~/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
max_temp: 100

[lis2dw]
cs_pin: EBB:gpio1
spi_bus: spi0a
axes_map: z,x,y

[resonance_tester]
probe_points: 100, 100, 20
accel_chip: lis2dw

[gcode_macro _global_var]
variable_heat_soak_time: 5  # Default heat soak time in minutes
variable_bed_mesh_calibrate_target_temp: 60  # Default mesh calibration temperature
gcode:
    # This is a placeholder to satisfy Klipper's requirement for a gcode option
    RESPOND MSG="This macro is for storing global variables only."

[delayed_gcode print_start_wait]
gcode:
    # Commands to execute after the delay
    M117 Print Start Wait Completed
    # Add any other final setup commands here
initial_duration: 0.5

[firmware_retraction]
retract_length: 0.8            # Base retraction length
retract_speed: 40              # Speed for retraction
unretract_extra_length: 0.0    # Extra filament on unretract
unretract_speed: 40            # Speed for unretraction

#####################################################################
#   Input Shaper Configuration
#####################################################################

# [adxl345]
# cs_pin: can0: PB12
# spi_software_sclk_pin: can0: PB10
# spi_software_mosi_pin: can0: PB11
# spi_software_miso_pin: can0: PB2
# axes_map: z,-y,x

# [resonance_tester]
# probe_points: 100, 100, 20
# accel_chip: adxl345

#####################################################################
# 	X/Y Stepper Settings
#####################################################################

[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
endstop_pin: tmc5160_stepper_x:virtual_endstop
# diag1_pin: ^PG6
microsteps: 16
rotation_distance: 40
position_endstop: 350
position_max: 350
homing_speed: 80
homing_retract_dist: 0
# second_homing_speed: 40 

[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
endstop_pin: tmc5160_stepper_y:virtual_endstop
#diag1_pin: !PG9
microsteps: 16
rotation_distance: 40
position_endstop: 361
position_max: 361
homing_speed: 80
homing_retract_dist: 0

#####################################################################
# 	Z Stepper Settings
#####################################################################

## Z0 Stepper - Front Left
[stepper_z]
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16
endstop_pin: probe:z_virtual_endstop   
position_min: -5
position_max: 330
homing_speed: 20
second_homing_speed: 3
homing_retract_dist: 3

###########################################################################
#   Z1+ Stepper Motorz
###########################################################################

[stepper_z1]
step_pin: PF9
dir_pin: !PF10
enable_pin: !PG2
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16

[stepper_z2]
step_pin: PE2
dir_pin: PE3
enable_pin: !PD4
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16

[stepper_z3]
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16

########################################
# TMC5160 configuration
########################################

[tmc5160 stepper_x]
cs_pin: PC4
spi_bus: spi1
diag1_pin: !PG6
run_current: 2.4
hold_current: 0.8
stealthchop_threshold: 0
driver_SGT: 2
# interpolate: True

[tmc5160 stepper_y]
cs_pin: PD11
spi_bus: spi1
diag1_pin: !PG9
run_current: 2.4
hold_current: 0.8
stealthchop_threshold: 0
driver_SGT: 1
# interpolate: True

[tmc5160 stepper_z]
cs_pin: PC6
spi_bus: spi1
diag1_pin: PG10
run_current: 0.900
hold_current: 0.3
stealthchop_threshold: 0

# [tmc5160 stepper_unallocated]
# cs_pin: PC7
# spi_bus: spi1
# #diag1_pin: PG11
# run_current: 0.800
# stealthchop_threshold: 0

[tmc5160 stepper_z1]
cs_pin: PF2
spi_bus: spi1
run_current: 0.900
hold_current: 0.3
stealthchop_threshold: 0

[tmc5160 stepper_z2]
cs_pin: PE1
spi_bus: spi1
run_current: 0.900
hold_current: 0.3
stealthchop_threshold: 0

[tmc5160 stepper_z3]
cs_pin: PE4
spi_bus: spi1
run_current: 0.900
hold_current: 0.3
stealthchop_threshold: 0

#[tmc5160 extruder3]
#cs_pin: PD3
#spi_bus: spi1
#run_current: 0.800
#stealthchop_threshold: 0

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=PC5


#####################################################################
#   Extruder Settings
#####################################################################

[tmc2209 extruder]
uart_pin: EBB:gpio20
run_current: 0.650
stealthchop_threshold: 999999

[filament_switch_sensor filament_sensor]
pause_on_runout: True
runout_gcode:
    M117 Filament Runout Detected ; Display a message
    PAUSE                         ; Pause the print
insert_gcode:
    M117 Filament Inserted        ; Display a message
    RESUME                        ; Resume the print
switch_pin: EBB:gpio13            ; Correct pin configuration

[extruder]
max_extrude_only_distance:1000.0
max_extrude_cross_section=1000.0
step_pin: EBB:gpio18
dir_pin: EBB:gpio19
enable_pin: !EBB:gpio17
rotation_distance: 46.515828537772  #Bondtech 5mm Drive Gears
gear_ratio: 9:1             #BMG Gear Ratio
microsteps: 32
full_steps_per_rotation: 200    #200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: EBB:gpio7
sensor_type: NTC 100K MGB18-104F39050L32
pullup_resistor: 2200 # 2.2K
sensor_pin: EBB:gpio26 
min_temp: 10
max_temp: 400
max_power: 1.0
min_extrude_temp: 170
pressure_advance: 0.04
#pressure_advance_smooth_time: 0.040

#####################################################################
#   Bed Heater Settings
#####################################################################

[heater_bed]
heater_pin: PA3
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF3
max_power: 1
min_temp: 0
max_temp: 115

#####################################################################
#   Fan Control
#####################################################################

[fan]
pin: EBB:gpio14
kick_start_time: 0.5
max_power: 1
off_below: 0.10

[heater_fan hotend_fan]
pin: EBB:gpio4
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

[controller_fan controller_fan]
pin: PD12
kick_start_time: 0.5
max_power: 0.5
heater: heater_bed

[controller_fan controller_fan2]
pin: PD13
kick_start_time: 0.5
max_power: 0.5
heater: heater_bed

[fan_generic Nevermore]
pin: PD14
max_power: 1.0
shutdown_speed: 0

# [heater_fan Nevermore]
# pin: PD14
# heater: extruder
# heater_temp: 240
# max_power: 1.0
# shutdown_speed: 0
# kick_start_time: 0.1

[temperature_fan EBB_SB2209]
pin: EBB:gpio5
sensor_type: Generic 3950
sensor_pin: EBB:gpio27
target_temp: 45.0
control: watermark
max_speed: 1.0
min_temp: 0
max_temp: 100
shutdown_speed: 0

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

[quad_gantry_level]
gantry_corners:
   -60,-10
   410,420
points:
   25, 8.5
   25, 308.5
   325, 308.5
   325, 8.5
speed: 600
horizontal_move_z: 5
retry_tolerance: 0.05
retries: 5
max_adjust: 30

#####################################################################
#   Display and Pin Configuration
#####################################################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=PC5

[exclude_object]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 38.101
#*# pid_ki = 12.095
#*# pid_kd = 30.005
#*#
#*# [probe]
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 56.642
#*# pid_ki = 1.807
#*# pid_kd = 443.935
#*#
#*# [input_shaper]
#*# shaper_type_x = 2hump_ei
#*# shaper_freq_x = 55.6
#*# shaper_type_y = mzv
#*# shaper_freq_y = 38.6
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 17
#*# calibrate =
#*# 	0.050000:3179769.341,0.090000:3179152.479,0.130000:3178479.914,
#*# 	0.170000:3177883.966,0.210000:3177252.962,0.250000:3176684.197,
#*# 	0.290000:3176079.820,0.330000:3175516.265,0.370000:3174925.636,
#*# 	0.410000:3174396.554,0.450000:3173866.072,0.490000:3173314.775,
#*# 	0.530000:3172778.647,0.570000:3172279.635,0.610000:3171730.008,
#*# 	0.650000:3171273.893,0.690000:3170780.606,0.730000:3170297.684,
#*# 	0.770000:3169839.374,0.810000:3169378.454,0.850000:3168914.763,
#*# 	0.890000:3168498.878,0.930000:3168054.155,0.970000:3167639.759,
#*# 	1.010000:3167215.075,1.050000:3166853.923,1.090000:3166434.517,
#*# 	1.130000:3166039.914,1.170000:3165653.730,1.210000:3165290.751,
#*# 	1.250000:3164909.684,1.290000:3164539.955,1.330000:3164170.806,
#*# 	1.370000:3163850.716,1.410000:3163497.954,1.450000:3163156.280,
#*# 	1.490000:3162819.972,1.530000:3162512.827,1.570000:3162173.371,
#*# 	1.610000:3161865.309,1.650000:3161558.234,1.690000:3161247.564,
#*# 	1.730000:3160940.132,1.770000:3160677.437,1.810000:3160382.117,
#*# 	1.850000:3160091.473,1.890000:3159790.572,1.930000:3159550.110,
#*# 	1.970000:3159288.971,2.010000:3159029.066,2.050000:3158752.107,
#*# 	2.090000:3158496.373,2.130000:3158249.547,2.170000:3158008.835,
#*# 	2.210000:3157761.365,2.250000:3157542.137,2.290000:3157320.560,
#*# 	2.330000:3157063.154,2.370000:3156819.098,2.410000:3156606.587,
#*# 	2.450000:3156386.072,2.490000:3156180.829,2.530000:3155967.127,
#*# 	2.570000:3155764.604,2.610000:3155556.395,2.650000:3155344.472,
#*# 	2.690000:3155149.037,2.730000:3154967.597,2.770000:3154795.999,
#*# 	2.810000:3154593.302,2.850000:3154399.096,2.890000:3154220.600,
#*# 	2.930000:3154041.482,2.970000:3153877.781,3.010000:3153695.231,
#*# 	3.050000:3153529.422,3.090000:3153367.553,3.130000:3153215.335,
#*# 	3.170000:3153025.559,3.210000:3152896.482,3.250000:3152732.266,
#*# 	3.290000:3152567.774,3.330000:3152433.844,3.370000:3152277.707,
#*# 	3.410000:3152142.179,3.450000:3151999.975,3.490000:3151840.136,
#*# 	3.530000:3151709.828,3.570000:3151553.737,3.610000:3151449.446,
#*# 	3.650000:3151277.765,3.690000:3151181.007,3.730000:3151034.596,
#*# 	3.770000:3150904.726,3.810000:3150785.994,3.850000:3150667.178,
#*# 	3.890000:3150555.517,3.930000:3150420.547,3.970000:3150292.868,
#*# 	4.010000:3150180.337,4.050000:3150070.220
#*#
#*# [temperature_probe btt_eddy]
#*# calibration_temp = 41.284939
#*# drift_calibration =
#*# 	3240943.203368, -589.134716, 4.941034
#*# 	3213776.929404, -233.054705, 2.018030
#*# 	3193917.331624, 0.207401, 0.092456
#*# 	3179021.889133, 170.503912, -1.342499
#*# 	3167936.055615, 286.395066, -2.320343
#*# 	3159443.113599, 372.176208, -3.048603
#*# 	3152854.249337, 437.275117, -3.613051
#*# 	3147834.526141, 479.792226, -3.970641
#*# 	3143861.849493, 511.816644, -4.235231
#*# drift_calibration_min_temp = 36.932440996638555
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.141333, -0.045580, -0.026606, -0.029655, -0.022424, -0.009222, 0.007356, 0.002908, 0.015995, 0.027499, 0.035863, 0.037285, 0.020419, -0.021621, -0.195117
#*# 	-0.008522, -0.003843, -0.008796, -0.007398, -0.000457, 0.011739, 0.026237, 0.029012, 0.021430, 0.038751, 0.049075, 0.039436, 0.043006, 0.042784, -0.005340
#*# 	0.027538, 0.023179, 0.014425, 0.005844, 0.022685, 0.024956, 0.039775, 0.040138, 0.028150, 0.031775, 0.035524, 0.032663, 0.042227, 0.029673, -0.003130
#*# 	0.026713, 0.014367, 0.018983, 0.025337, 0.023597, 0.029535, 0.052527, 0.053824, 0.038471, 0.046317, 0.038616, 0.036469, 0.043254, 0.035376, -0.007065
#*# 	0.038525, 0.031631, 0.035317, 0.023965, 0.017427, 0.029979, 0.058285, 0.054264, 0.040334, 0.035384, 0.036809, 0.031812, 0.030024, 0.026458, -0.006363
#*# 	0.042988, 0.029278, 0.029818, 0.027853, 0.025196, 0.032233, 0.073450, 0.073450, 0.040443, 0.024532, 0.024532, 0.029232, 0.024107, 0.018509, -0.032572
#*# 	0.038869, 0.028390, 0.026105, 0.026573, 0.017597, 0.040556, 0.094087, 0.073640, 0.022721, 0.017769, 0.042195, 0.027656, 0.016155, 0.013665, -0.026091
#*# 	0.026548, 0.018660, 0.007466, -0.000943, -0.000484, 0.019370, 0.050083, 0.023239, -0.005342, -0.002040, 0.024028, 0.007190, -0.008342, -0.007028, -0.042227
#*# 	0.019826, 0.009263, -0.003578, -0.007133, -0.009888, 0.009581, 0.010487, -0.015489, -0.031675, -0.016758, -0.011758, -0.015146, -0.012097, -0.019132, -0.060464
#*# 	0.012232, -0.003623, -0.003299, -0.014641, -0.011249, 0.000072, -0.006530, -0.021691, -0.022423, -0.022920, -0.020211, -0.022167, -0.025026, -0.034853, -0.063360
#*# 	0.012141, 0.017871, 0.012527, 0.013699, 0.019456, 0.011403, -0.000145, -0.019877, -0.023522, -0.020130, -0.033010, -0.018480, -0.028897, -0.026608, -0.057126
#*# 	0.019944, 0.000323, 0.010893, 0.029154, 0.025345, 0.015120, -0.003995, -0.011083, -0.027348, -0.019216, -0.025996, -0.030892, -0.029540, -0.036321, -0.068769
#*# 	0.007692, 0.017099, 0.049136, 0.047711, 0.032362, 0.022791, 0.001354, -0.023243, -0.028947, -0.030638, -0.029289, -0.039780, -0.038653, -0.035952, -0.064881
#*# 	0.002601, 0.011968, 0.048372, 0.071252, 0.040956, 0.017742, -0.010316, -0.028770, -0.035204, -0.037163, -0.037163, -0.042323, -0.035884, -0.040625, -0.065831
#*# 	-0.003649, 0.001212, 0.018319, 0.031415, 0.040609, 0.023995, -0.015060, -0.033360, -0.043493, -0.044847, -0.048657, -0.040104, -0.041709, -0.038574, -0.062695
#*# x_count = 15
#*# y_count = 15
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 334.90000000000003
#*# min_y = 22.0
#*# max_y = 331.95999999999987
